generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ── Fortune request (입력 기록) ─────────────────────────
model FortuneRequest {
  id           String   @id @default(cuid())
  name         String
  birthDate    String
  birthTime    String?
  gender       String
  calendarType String
  createdAt    DateTime @default(now())

  orders    Order[]
  llmUsages LlmUsage[]
}

// ── Order (주문) ────────────────────────────────────────
model Order {
  id              String   @id @default(cuid())
  requestId       String
  productCode     String
  amountKrw       Int           // Legacy KRW amount (kept for backward compat)
  amount          Int?          // Amount in smallest currency unit (cents, yen, won, etc.)
  currency        String    @default("KRW")
  countryCode     String    @default("kr")
  locale          String    @default("ko")
  paymentProvider String?       // "toss" | "stripe" | "razorpay"
  paymentId       String?       // External payment ID (e.g. Stripe session ID)
  status          String    @default("created")
  email           String?
  emailSentAt     DateTime?  @map("email_sent_at")
  createdAt       DateTime  @default(now())
  confirmedAt     DateTime?

  request FortuneRequest @relation(fields: [requestId], references: [id])
  reports Report[]
}

// ── Report (리포트) ─────────────────────────────────────
model Report {
  id          String   @id @default(cuid())
  orderId     String
  model       String
  productCode String
  tier        String   @default("free")  // "free" | "paid"
  headline    String
  summary     String
  sectionsJson String
  recommendationsJson String
  disclaimer  String
  generatedAt DateTime @default(now())
  expiresAt   DateTime?  // null for paid (permanent), 90 days for free

  order Order @relation(fields: [orderId], references: [id])
}

// ── LLM Usage (비용 추적) ───────────────────────────────
model LlmUsage {
  id          String   @id @default(cuid())
  requestId   String?
  provider    String
  model       String
  inputTokens  Int?
  outputTokens Int?
  totalTokens  Int?
  durationMs   Int?
  estimatedCostUsd Float?
  createdAt   DateTime @default(now())

  request FortuneRequest? @relation(fields: [requestId], references: [id])
}

// ── Prompt Cache (프롬프트 캐시) ────────────────────────
model PromptCache {
  id        String   @id @default(cuid())
  cacheKey  String   @unique
  provider  String
  model     String
  response  String
  usageJson String?
  createdAt DateTime @default(now())
  expiresAt DateTime?
}

// ── Anonymous User (비로그인 사용자) ─────────────────────
model User {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String?
  anonymousUuid String   @unique @map("anonymous_uuid")
  locale        String   @default("ko")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("users")
}

// ── Email Subscription (이메일 구독) ─────────────────────
model EmailSubscription {
  id        String   @id @default(cuid())
  email     String
  source    String   // "checkout" | "coming_soon" | "monthly_fortune"
  locale    String   @default("ko")
  optedIn   Boolean  @default(true) @map("opted_in")
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([email, source])
  @@map("email_subscriptions")
}

// ── Model Vote (모델 투표) ────────────────────────────────
model ModelVote {
  id        String   @id @default(cuid())
  orderId   String
  modelKey  String
  voterId   String   // 브라우저 localStorage UUID
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([orderId, modelKey, voterId])
  @@index([orderId])
  @@map("model_votes")
}

// ── Rate Limit Log (요청 제한 로그) ──────────────────────
model RateLimitLog {
  id          String   @id @default(cuid())
  ip          String
  fingerprint String?
  uuid        String?
  endpoint    String
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([ip, createdAt])
  @@index([uuid, createdAt])
  @@map("rate_limit_logs")
}
